/*
 * Name:	SupportVehiclesService
 * Date:	2019-10-04
 * Version: 1.0
 * Author:  Engima
 *
 * Description:
 * A service that "heals" vehicles when a support vehicle comes near.
 */

using Intrusion.Common;
using Intrusion.Communication;

namespace Intrusion.Server
{
	public class SupportVehiclesService : Service
	{
		// Creates a SupportVehiclesService object.
		public constructor()
		{
		};
		
		private method Object GetClosestVehicleWithinHealDistance("_supportVehicle" as Object)
		{
			{
				if (_x != _supportVehicle) then {
					if (_x distance _supportVehicle < 10) then {
						return _x;
					};
				};
			} foreach vehicles;
			
			return objNull;
		};
		
		protected override method Run()
		{
			private ["_intrusionVehicle" as IntrusionVehicle, "_closeVehicle" as Object];
			
			while { true } do {
				{
					_intrusionVehicle = _x getVariable ["IntrusionVehicle", classNull];
					
					// If vehicle is an intrusion vehicle of a support type
					
					if (!isNull _intrusionVehicle && { _intrusionVehicle.OwnerProfession == ProfessionType.Repair || _intrusionVehicle.OwnerProfession == ProfessionType.Fuel || _intrusionVehicle.OwnerProfession == ProfessionType.Ammo }) then
					{
						_closeVehicle = [_x] call _self.GetClosestVehicleWithinHealDistance;
						
						// If there is a close vehicle near, and if both vehicles is stationary
						
						if (!isNull _closeVehicle && { alive _closeVehicle && { speed _intrusionVehicle.Vehicle < 0.1 && speed _closeVehicle < 0.1 }}) then
						{
							if (_intrusionVehicle.OwnerProfession == ProfessionType.Repair) then
							{
								if (([_closeVehicle] call Functions.GetVehicleDamage) > 0.1 || !canMove _closeVehicle) then {
									_closeVehicle setDamage 0;
									["ClientEventReciever.OnVehicleSupported", [_closeVehicle, _intrusionVehicle.Vehicle, "Your vehicle was repaired by allied repair vehicle.", "Vehicle was repaired."]] call Remote.Invoke;
								};
							};
							
							if (!isNull _intrusionVehicle && { _intrusionVehicle.OwnerProfession == ProfessionType.Fuel }) then
							{
								if (fuel _closeVehicle < 0.9) then
								{
									_closeVehicle setFuel 1;
									["ClientEventReciever.OnVehicleSupported", [_closeVehicle, _intrusionVehicle.Vehicle, "Your vehicle was refueld by allied refuel vehicle.", "Vehicle was refueld."]] call Remote.Invoke;
								};
							};
							
							if (!isNull _intrusionVehicle && { _intrusionVehicle.OwnerProfession == ProfessionType.Ammo }) then
							{
								if ([_closeVehicle] call Functions.GetVehicleAmmo < 0.9) then
								{
									_closeVehicle setVehicleAmmo 1;
									["ClientEventReciever.OnVehicleSupported", [_closeVehicle, _intrusionVehicle.Vehicle, "Your vehicle was rearmed by allied ammo vehicle.", "Vehicle was rearmed."]] call Remote.Invoke;
								};
							};					
						};
					};
				} foreach vehicles;
				
				sleep 5;
			};
		
			call _base.Run;
		};
	};
};
